-- Remove o banco de dados se já existir e cria um novo
DROP DATABASE IF EXISTS projetoJDBC;

CREATE DATABASE projetoJDBC;

USE projetoJDBC;

-- Criação das tabelas
CREATE TABLE conta (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    foto longblob,
    nome VARCHAR(200) NOT NULL,
    telefone VARCHAR(200) NOT NULL,
    e_mail VARCHAR(200) NOT NULL,
    cpf VARCHAR(100) UNIQUE NOT NULL,
    endereco VARCHAR(200),
    login VARCHAR(200),
    senha VARCHAR(200),
    tipo_conta VARCHAR(200),
    data_registro DATE,
    salario_funcionario FLOAT,
    inicio_expediente_funcionario TIME,
    fim_expediente_funcionario TIME,
    mensalidade_cliente FLOAT
);

CREATE TABLE equipamento (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(200) NOT NULL,
    imagem longblob,
    tipo VARCHAR(100) NOT NULL,
    status_equipamento BOOLEAN NOT NULL,
    conta_criador INT,
    data_registro DATE,
    FOREIGN KEY (conta_criador) REFERENCES conta(ID)
);

CREATE TABLE modificacoes (
    data_modificacao DATE NOT NULL,
    campo_modificado VARCHAR(200) NOT NULL,
    conta_modificador INT,
    equipamento_modificado INT,
    FOREIGN KEY (conta_modificador) REFERENCES conta(ID),
    FOREIGN KEY (equipamento_modificado) REFERENCES equipamento(ID)
);

CREATE TABLE treino (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(200) NOT NULL,
    duracao TIME NOT NULL,
    descricao VARCHAR(200),     
    conta_cliente INT,
    FOREIGN KEY (conta_cliente) REFERENCES conta(ID)
);

CREATE TABLE reservas (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    data_reserva DATE NOT NULL,
    hora_inicio TIME NOT NULL,
    hora_fim TIME NOT NULL,
    status INT,
    conta_cliente INT,
    equipamento INT,
    FOREIGN KEY (conta_cliente) REFERENCES conta(ID),
    FOREIGN KEY (equipamento) REFERENCES equipamento(ID)
);

CREATE TABLE uso_de_equipamento (
    tempo_de_uso TIME NOT NULL,
    treino INT,
    equipamento INT,
    FOREIGN KEY (treino) REFERENCES treino(ID),
    FOREIGN KEY (equipamento) REFERENCES equipamento(ID)
);

-- Criação do trigger
DELIMITER //

CREATE TRIGGER after_equipamento_update
AFTER UPDATE ON equipamento
FOR EACH ROW
BEGIN
    -- Insere um novo registro na tabela de modificações
    INSERT INTO modificacoes (data_modificacao, campo_modificado, conta_modificador, equipamento_modificado)
    VALUES (CURRENT_DATE, 
            IF(OLD.nome != NEW.nome, 'nome', 
                IF(OLD.tipo != NEW.tipo, 'tipo',
                    IF(OLD.status_equipamento != NEW.status_equipamento, 'status_equipamento', 
                        IF(OLD.conta_criador != NEW.conta_criador, 'conta_criador', 
                            IF(OLD.data_registro != NEW.data_registro, 'data_registro', 
                                'unknown'))))), 
            NEW.conta_criador, 
            NEW.ID);
END//

DELIMITER ;

DELIMITER //

CREATE TRIGGER after_uso_de_equipamento_insert
AFTER INSERT ON uso_de_equipamento
FOR EACH ROW
BEGIN
    -- Variável para armazenar a nova duração do treino
    DECLARE nova_duracao TIME;

    -- Soma o tempo de uso de todos os equipamentos relacionados ao treino
    SELECT SEC_TO_TIME(SUM(TIME_TO_SEC(tempo_de_uso)))
    INTO nova_duracao
    FROM uso_de_equipamento
    WHERE treino = NEW.treino;

    -- Atualiza a duração do treino na tabela treino
    UPDATE treino
    SET duracao = nova_duracao
    WHERE ID = NEW.treino;
END//

DELIMITER ;


-- População inicial dos dados

-- Inserindo a conta admin
INSERT INTO conta (nome, telefone, e_mail, cpf, endereco, login, senha, tipo_conta, data_registro)
VALUES ('Administrador', '123456789', 'admin@gym.com', '11111111111', 'Rua Principal, 123', 'admin', 'admin', 'admin', CURDATE());

-- Exemplo de inserção de outros dados
INSERT INTO conta (nome, telefone, e_mail, cpf, endereco, login, senha, tipo_conta, data_registro)
VALUES ('João Silva', '987654321', 'joao@gym.com', '22222222222', 'Rua Secundária, 456', 'joao', 'senha123', 'cliente', CURDATE());

INSERT INTO equipamento (nome, tipo, status_equipamento, conta_criador, data_registro)
VALUES ('Esteira', 'Cardio', TRUE, 1, CURDATE());

INSERT INTO equipamento (nome, tipo, status_equipamento, conta_criador, data_registro)
VALUES ('Bicicleta', 'Cardio', TRUE, 1, CURDATE());

INSERT INTO treino (nome, duracao, descricao, conta_cliente)
VALUES ('Treino A', '01:00:00', 'Treino de resistência', 2);

INSERT INTO reservas (data_reserva, hora_inicio, hora_fim, status, conta_cliente, equipamento)
VALUES (CURDATE(), '10:00:00', '11:00:00', 1, 2, 1);
